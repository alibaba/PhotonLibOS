name: Linux Compiler

on:
  push:
    branches: [ "main", "release/*" ]
  pull_request:
    branches: [ "main", "release/*" ]

jobs:
  gcc850:
    runs-on: [self-hosted, compiler]
    steps:
      - uses: actions/checkout@v3
      - name: Build850
        run: |
          rm -fr build
          cmake -B build -D CMAKE_BUILD_TYPE=MinSizeRel   \
                         -D PHOTON_BUILD_TESTING=ON       \
                         -D PHOTON_ENABLE_SASL=ON         \
                         -D PHOTON_ENABLE_FUSE=ON         \
                         -D PHOTON_ENABLE_URING=ON        \
                         -D PHOTON_ENABLE_EXTFS=ON        \
                         -D PHOTON_BUILD_DEPENDENCIES=ON  \
                         -D PHOTON_AIO_SOURCE=""          \
                         -D PHOTON_ZLIB_SOURCE=""         \
                         -D PHOTON_CURL_SOURCE=""         \
                         -D PHOTON_OPENSSL_SOURCE=""      \
                         -D PHOTON_GFLAGS_SOURCE=""       \
                         -D PHOTON_GOOGLETEST_SOURCE=""   \
                         -D PHOTON_URING_SOURCE=https://github.com/axboe/liburing/archive/refs/tags/liburing-2.3.tar.gz \

          cmake --build build -j $(nproc) --clean-first -- VERBOSE=1
          rm -f build/output/*.a
          tar -c --use-compress-program=zstdmt -f output850.tar.zstd build/output/
      - name: Upload850
        uses: actions/upload-artifact@v4
        with:
          name: output850.tar.zstd
          path: output850.tar.zstd
          retention-days: 5
          compression-level: 0

  gcc921:
    needs: gcc850
    runs-on: [self-hosted, compiler]
    steps:
      - name: Build921
        run: |
          source /opt/rh/gcc-toolset-9/enable
          cmake --build build -j $(nproc) --clean-first -- VERBOSE=1
          rm -f build/output/*.a
          tar -c --use-compress-program=zstdmt -f output921.tar.zstd build/output/
      - name: Upload921
        uses: actions/upload-artifact@v4
        with:
          name: output921.tar.zstd
          path: output921.tar.zstd
          retention-days: 5
          compression-level: 0

  gcc1031:
    needs: gcc921
    runs-on: [self-hosted, compiler]
    steps:
      - name: Build1031
        run: |
          source /opt/rh/gcc-toolset-10/enable
          cmake --build build -j $(nproc) --clean-first -- VERBOSE=1
          rm -f build/output/*.a
          tar -c --use-compress-program=zstdmt -f output1031.tar.zstd build/output/
      - name: Upload1031
        uses: actions/upload-artifact@v4
        with:
          name: output1031.tar.zstd
          path: output1031.tar.zstd
          retention-days: 5
          compression-level: 0

  gcc1121:
    needs: gcc1031
    runs-on: [self-hosted, compiler]
    steps:
      - name: Build1121
        run: |
          source /opt/rh/gcc-toolset-10/enable
          cmake --build build -j --clean-first -- VERBOSE=1
          rm -f build/output/*.a
          tar -c --use-compress-program=zstdmt -f output1121.tar.zstd build/output/
      - name: Upload1121
        uses: actions/upload-artifact@v4
        with:
          name: output1121.tar.zstd
          path: output1121.tar.zstd
          retention-days: 5
          compression-level: 0

  gcc1211:
    needs: gcc1121
    runs-on: [self-hosted, compiler]
    steps:
      - name: Build1211
        run: |
          source /opt/rh/gcc-toolset-10/enable
          cmake --build build -j $(nproc) --clean-first -- VERBOSE=1
          rm -f build/output/*.a
          tar -c --use-compress-program=zstdmt -f output1211.tar.zstd build/output/
      - name: Upload1211
        uses: actions/upload-artifact@v4
        with:
          name: output1211.tar.zstd
          path: output1211.tar.zstd
          retention-days: 5
          compression-level: 0


